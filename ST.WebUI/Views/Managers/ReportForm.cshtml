@model ST.WebUI.ViewModels.ReportFormViewModel
@{
    ViewBag.Title = "ReportForm";
}

<h2>ReportForm</h2>

<div class="report-options">
    <div class="controls">
        <button class="btn btn-default add-filter">Add Filter</button>
    </div>
    <div class="filters">
        <div id="filter-0" class="filter">

            <div class="form-group">
                <label>Select Category</label>
                <select class="form-control categories" data-wired="false">
                    <option selected disabled>Select category</option>
                    @foreach (var category in Model.Categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Select Skill</label>
                <select id="filter-0" class="form-control skills"></select>
            </div>

            <div class="form-group comparer-container">
                <label>Comparer</label>
                <select class="form-control comparer">
                    <option value="0">>=</option>
                    <option value="1"><=</option>
                    <option value="2">==</option>
                </select>
            </div>

            <div class="form-group rating-container">
                <label>Rating</label>
                <select class="form-control rating">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
        </div>
    </div>
    <div class="actions">
        <button class="btn btn-default begin-search">Begin Search</button>
        <button class="btn btn-info save-report disabled">Save Report</button>
    </div>
</div>
<hr />
<h2>Results:</h2>
<div id="results">

</div>

@section scripts
{
    <script>
        $(function () {
            var counter = 1;
            wireEvents();    

            $('.add-filter').on('click', function () {
                addFilter(counter);
                counter++;
            });
            $('.save-report').on('click', onSaveReport);
        });

        function addFilter(counter) {
            var filters = $('.filters');

            var categories = $('<select class="form-control categories" data-wired="false"></select>');
            populateCategories(categories);

            var filter = $(`<div id="filter-${counter}" class="filter"></div>`)
                .append($('<div class="form-group"></div>')
                    .append(categories)
                )
                .append($('<div class="form-group"></div>')
                    .append($(`<select id="filter-${counter}" class="form-control skills"></select>`))
                )
                .append($('<div class="form-group comparer-container"></div>')
                    .append($('<select class="form-control comparer"></select>')
                        .append($('<option value="0">>=</option>'))
                        .append($('<option value="1"><=</option>'))
                        .append($('<option value="2">==</option>'))
                    )
                )
                .append($('<div class="form-group rating-container"></div>')
                    .append($('<select class="form-control rating"></select>')
                        .append($('<option value="1">1</option>'))
                        .append($('<option value="2">2</option>'))
                        .append($('<option value="3">3</option>'))
                        .append($('<option value="4">4</option>'))
                        .append($('<option value="5">5</option>'))
                    )
                );

            filters.append(filter);
            wireEvents();
        };

        function populateCategories(categories) {
            $.ajax({
                url: '/api/categories/GetAll',
                method: 'POST'
            })
                .done(function (response) {

                    var emptyOption = `<option selected disabled>Select category</option>`;
                    categories.append(emptyOption);

                    $.each(response, function (index, item) {
                        var option = `<option value="${item.Id}">${item.Name}</option>`;
                        categories.append(option);
                    });
                })
                .fail(function () {
                    alert('Error');
                });
        };

        function wireEvents() {
            $('.categories[data-wired="false"]').change(function (e) {
                var id = $(e.target).closest(".filter").attr('id');
                var categoryId = $(e.target).find(":selected").val();
                var skills = $(`.skills[id="${id}"]`);
                $.ajax({
                    url: "/api/skills/GetSkillsByCategory/" + categoryId,
                    method: "POST"
                })
                    .done(function (response) {
                        skills.empty();

                        $.each(response, function (index, item) {
                            var option = `<option value="${item.Id}">${item.Name}</option>`;
                            skills.append(option);
                        });
                    })
                    .fail(function () {
                        alert("Error.");
                    })


                $(this).attr('data-wired', true);
            });

            $('.begin-search').on('click', onBeginSearch);
        }

        function onBeginSearch() {
            var filterDtos = [];
            var filters = $('.filter');

            $.each(filters, function (index, item) {
                var categoryId = $(item).find('.categories').val();
                var skillId = $(item).find('.skills').val();
                var comparer = $(item).find('.comparer').val();
                var rating = $(item).find('.rating').val();

                filterDtos.push({
                    categoryId,
                    skillId,
                    comparer,
                    rating
                });
            });

            var data = JSON.stringify(filterDtos);
            localStorage.setItem("filterDtos", data);

            $.ajax({
                url: '/api/reports/search/',
                data: data,
                contentType: 'application/json',
                method: 'POST'
            })
                .done(function (response) {
                    var results = $('#results').empty();

                    $.each(response, function (key, dev) {

                        var skills = $('<div class="skills-container"></div>')

                        $.each(dev.SkillRatings, function (key, entry) {
                            var categoryGroup = $('<p></p>')
                                .append($(`<strong>${key}: </strong>`));

                            $.each(entry, function (key, skill) {
                                categoryGroup.append($(`<span> ${skill.SkillName} (${skill.Rating}/5) </span>`));
                            })

                            skills.append(categoryGroup);
                        });

                        var devDesc = $('<div class="dev-description"></div>')
                            .append($('<h3></h3>')
                                .append($(`<a href="/managers/developerprofile?email=${dev.Email}">${dev.FirstName} ${dev.LastName} </a>`))
                                .append($(`<small>${dev.Email}</small>`))
                            )
                            .append(skills);

                        results.append(devDesc);
                    });
                    if (response.length) {
                        localStorage.setItem('searchResults', JSON.stringify(response));
                        $('.save-report').removeClass('disabled');
                    } else {
                        $('.save-report').addClass('disabled');
                        results.empty().append($('<p class="text-info">No matches found.</p>'));
                    }
                })
                .fail(function () {
                    alert('error');
                });
        }
        function onSaveReport() {
            var self = $(this);
            self.closest('div')
                .append($('<input id="report-name" type="text" placeholder="report name" class="form-control" required/>'))
                .append($('<button class="btn btn-success save-ok">OK</button>'));

            $('.save-ok').on('click', function () {
                var reportNameInput = document.getElementById('report-name');

                if (reportNameInput.validity.valid) {

                    var name = $(reportNameInput).val();

                    var filters = JSON.parse(localStorage.getItem('filterDtos'));
                    var searchResults = JSON.parse(localStorage.getItem('searchResults'));
                    $.ajax({
                        url: "/api/reports/SaveReport",
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            filters,
                            searchResults,
                            name
                        })
                    })
                        .done(function () {
                            alert('yes!!');
                        })
                        .fail(function () {
                            alert('error');
                        });                   

                    

                    //window.location.replace("/");

                } else {
                    alert('Please enter report name.');
                }             
            });
        }
    </script>
}
